---
title: "Kernel Hardening using Grsecurity & RBAC System"
date: 2009-05-30 20:12:29 -0500
categories: ["Arabnix", "Footprinting", "Kernel", "Linux Security", "Security"]
tags: ["BIOS", "c99", "Compile", "fingerprinting", "gradmn", "Grsecurity", "Grub", "Kernel", "Kernel Panic", "make", "menuconfig", "nmap", "Patch", "Policy", "RBAC", "Role Based Access Control", "root", "TCP Stack", "uname", "Xprobe2"]
permalink: "/2009/05/30/kernel-hardening-using-grsecurity-rbac-system/"
reading_time: 10
---

السلام عليكم ورحمة الله وبركاته

![](/assets/img/posts/2009/fingerprint.jpg)

قبل فترة طويلة من الزمن الكثير من الأخوة الأصدقاء المقربين كانوا يستغربون كيف كنت أقوم بإعطاءهم المستخدم root الى خادم [عرب نيكس](http://arabnix.com) ولم يعرف أحدهم من عمل أي شيء على الخادم (ملاحظة، الموقع حالياً ليس على نفس الخادم السابق، تم نقله لأسباب كثيرة ربما أذكرها لاحقاً) !!! وأيضاً البعض كان يحاول معرفة ما هو النظام الذي يعمل عليه موقع عرب نيكس من خلال عمليات الـ fingerprinting للنظام ولم يعرفوا أيضاً صح يا صبري؟ :) والسبب بإننا سنقوم بعملية التلاعب بالـ TCP Stack أيضاً وبالتالي برامج مثل Xprobe2 أو nmap أو غيرها لن تستطيع معرفة ما هو النظام وما هي نواته !!!

السبب هو الطريقة التي كنت أستعملها على النظام وقتها والتي سأقوم بشرحها بالأسفل بالتفصيل الممل إن شاء الله … هذه الطريقة ستقوم بعملية حماية نظامك حتى من المستخدم root نفسه وبالتالي من يحصل على root على نظامك لن يعرف أن يعمل اي شيء سوى الدهشة والإستغراب والمسائلة لنفسه “ما الذي يحدث؟” :) طبعاً العلم لم يتوقف هنا وربما هناك طرق لإختراق مثل هذه الحماية “المعقدة” جداً جداً جداً ولكني أؤكد لكم بإنها بدون شك ستكون سداً منيعاً أمام هؤلاء أصحاب c99 والذي لن يعرف أحدهم أن يعمل شيء سوى تغيير أندكس !!! يعني حتى لو حصل على root لن يكون قادراً على تدمير الخادم لك، وكما قلت أقصى شي سيقوم به هو “أسلوب الأطفال” تغيير الأندكس !!!

وقبل أن أبدأ بالشرح، ولأنني أؤمن بإنه كلما أعطيت أكثر ونشرت مواضيع أكثر، كلما زادت معرفتك … فمن ظن بإن العلم عنده فقط؟ فهو جاهل … ومن ظن بإنه وصل الى كل شيء؟ فهو جاهل أيضاً … العلم إن نشرته فأنت فعلياً قمت بزكاته … وكما يقول **علي بن أبي طالب (رضي الله عنه)**: زكاة العلم نشره … ولأنني أتمنى أن تكف عمليات التخريب التي أسمع بها هنا وهناك لهذه الجهة أو تلك ولأسباب شخصية بين أفراد يظلم على ضوئها المئات وربما الآلاف من الناس بدون ذنب … فمنهم من يخترق فقط لكي يقول أنا وأنا ونسي حتى أن يقول “أعوذ بالله من كلمة أنا” ومنهم من يخترق لغرض الضرر بالطرف الآخر ويؤذيه سواءاً بشكل مادي، معنوي أو حتى نفسي … ولهذا الموضوع هذا سيكون كما أمرنا رسولنا الكريم، **محمد (صلى الله عليه وسلم)**: “المسلم أخو المسلم، لا يظلمه ولا يسلمه، من كان في حاجة أخيه، فإن الله في حاجته، ومن فرج عن مسلم كربة، فرج الله عنه بها كربة من كرب يوم القيامة، ومن ستر مسلما، ستره الله يوم القيامة”. الرسالة أظنها وصلت ولا حاجة لي لكتابة المزيد فالـ لبيب من الإشارة يفهموا …

لندخل الى الموضوع الآن …

سنقوم بتركيب patch الـ grsecurity وبناء النواة، وتنصيبها … وبعد ذلك سنقوم بتفعيل الـ RBAC System على النظام …

أول شيء لنقوم بعملية الترقيع مع البناء … أدخل المجلد التالي:

cd /usr/local/src

الآن لنقوم بتحميل النواة والترقيع الخاص بالـ grsecurity من خلال الأوامر التالية:

wget -c http://www.kernel.org/pub/linux/kernel/v2.6/linux-2.6.27.10.tar.bz2

wget -c http://www.grsecurity.com/grsecurity-2.1.12-2.6.27.10-200812271347.patch.gz

الآن لنفك ضغطهم:

tar xjvf linux-2.6.27.10.tar.bz2

gunzip grsecurity-2.1.12-2.6.27.10-200812271347.patch.gz

الآن لنقوم بعملية الترقيع:

patch -p0

الآن قم بعمل التالي:

mv linux-2.6.27.10 linux-2.6.27.10-grsec

ln -s linux-2.6.27.10-grsec/ linux

cd linux

والآن قم بنسخ ملف الـ config الخاص بالنواة التي تعمل عندك حالياً، لكي نستعملها في عملية بناء النواة بدل من عملها من الصفر:

cp /boot/config-`uname -r` .

الآن لندخل الى مرحلة بناء النواة:

make menuconfig

الآن من خلال القائمة بإختيار ملف الـ config هذا الذي نسخناه قبل قليل ...

الآن أدخل الى قائمة GrSecurity لكي نقوم ببعض التعديلات والتفعيلات ... وأرجوا أن تقوموا بإتباع الصور التالية في الإعداد:

![](/assets/img/posts/2009/grsec1.jpeg)

![](/assets/img/posts/2009/grsec2.jpeg)

![](/assets/img/posts/2009/grsec3.jpeg)

![](/assets/img/posts/2009/grsec4.jpeg)

![](/assets/img/posts/2009/grsec5.jpeg)

![](/assets/img/posts/2009/grsec6.jpeg)

![](/assets/img/posts/2009/grsec7.jpeg)

![](/assets/img/posts/2009/grsec8.jpeg)

![](/assets/img/posts/2009/grsec9.jpeg)

![](/assets/img/posts/2009/grsec10.jpeg)

![](/assets/img/posts/2009/grsec11.jpeg)

![](/assets/img/posts/2009/grsec12.jpeg)

![](/assets/img/posts/2009/grsec13.jpeg)

![](/assets/img/posts/2009/grsec14.jpeg)

![](/assets/img/posts/2009/grsec15.jpeg)

ملاحظة مهمة: هناك خيارات كثيرة جداً ومتعددة جداً ... لا أستطيع شرح وتوضيح جميعها، ويوجد كتاب رائع في هذا المجال ممكن يفيدكم لمن يود المزيد من المعرفة: [أضغط هنا](http://www.amazon.com/Role-Based-Access-Control-David-Ferraiolo/dp/1580533701)

الآن قم بحفظ الإعدادات والخروج لنذهب لعملية بناء وتثبيت النواة الجديدة ... والتي يمكن عملها بالخطوات التالية:

make bzImage

make modules

make modules_install

make install

الآن قبل ان تقوم بإعادة تشغيل الجهاز للعمل على النواة الجديدة grsec لنقوم ببعض الأمور ... أولاً قم بتحرير ملف grub:

vim /boot/grub/grub.conf

أذهب الى السطور الجديدة التي تخص النواة الجديدة والتي ستكون كهذه:

title CentOS (2.6.27.10-grsec)

root (hd1,0)

kernel /vmlinuz-2.6.27.10-grsec ro root=LABEL=/

initrd /initrd-2.6.27.10-grsec.img

وضع بآخر السطر الثالث (الذي يبدأ بكلمة kernel) التالي:

panic=4

لكي يصبح هكذا:

title CentOS (2.6.27.10-grsec)

root (hd1,0)

kernel /vmlinuz-2.6.27.10-grsec ro root=LABEL=/ panic=4

initrd /initrd-2.6.27.10-grsec.img

هذه لكي نظمن في حالة حصل خلل في النواة الجديدة (Kernel Panic) سيعيد تشغيل النظام لك بعد 4 ثواني (على إعتبار إنك تطبق هذه العمليات على خادم عن بعد وليس لديك إتصال مباشر على BIOS الخادم) ... الآن لندخل الى طرفية grub لكي نقوم بتثبيت عملية إعادة الإقلاع من هذه النواة لمرة واحدة خوفاً من حدوث مشكلة ما ولكي يقوم بعملية الإقلاع من النواة الأخرى في المرة القادمة ...

نفذ التالي:

grub

savedefault --default=0 --once

quit

هكذا ثبتنا لبرنامج الإقلاع grub بإنه يقوم بعملية الإقلاع من النواة الجديدة والتي هي default=0 مرة واحدة فقط ... الآن أعد تشغيل النظام وأنتظر الى أن يعود للعمل وقم بالدخول على النظام وتأكد ما هي النواة التي تعمل الآن من خلال الأمر:

uname -r

إذا كان الجواب هو:

2.6.27.10-grsec

هذا يعني بإنه الأمور تمت بنجاح والنواة الجديدة تعمل بشكل سليم ... إن ظهرت لك النواة القديمة، هذا يعني بإن هناك خلل ما في النواة وعليك حلها ... أو ربما إعادة عملية بناء النواة وتثبيتها من جديد ... الآن كل شيء تمام؟ قم بتحرير ملف grub.conf وأحذف منه panic=4 ...

الى هنا أنتهينا من تثبيت النواة والباتش Grsecurity الجديدة ... مبروك الخطوة الأولى :)

الآن وبعد أن قمنا بتركيب النواة الجديدة، لنقوم بالإستفادة من نظام الـ RBAC والذي هو إختصار لـ Role Based Access Control الموجود مع Grsecurity وذلك لكي تتم عملية إحتواء الهجمات والمخاطر التي ممكن أن توجه على الخادم ...

الأمر بسيط إن شاء الله، لنقم بتحميل برنامج gradmn بالبداية:

wget -c http://www.grsecurity.com/gradm-2.1.12-200812271437.tar.gz

بعد ذلك لنفك الضغط عنه وندخل المجلد الناتج:

tar xvfz gradm-2.1.12-200812271437.tar.gz

بعد ذلك نفذ التالي:

cd gradm2

make

make install

جميل جميل الأمور تسير بشكل ممتاز "على الأقل عندي :)" ... الآن أرجوا أن تركزوا على الجمل التي سأقولها هنا:

الآن برنامج gradm هو للتحكم بالـ RBAC الموجود، ولكن بالبداية يجب أن نقوم بعملية تعليم الـ RBAC ما هي إحتياجاتنا وما هي الأمور التي يجب أن يقوم بعملية حماية لها ... هي تشبه الى حد كبير أنظمة الذكاء الإصطناعي والأنظمة الخبيرة التي تتعلم من ذاتها من خلال العمليات التي تعمل بداخل النظام ... ولهذا نحتاج بالبداية قبل أن نقوم بتفعيل النظام بتعليمه أي ندخل مرحلة تعليمه Learning Phase ... في هذه المرحلة يا أخوان "لا" تقوم بأي عملية تنفيذية تستوجب إستعمال مدير النظام ... اي لا تقوم بأي عملية هي عبارة عن Administrative task ... الرجاء أكرر "لا" تقوم بأي عملية Administrative خلال مرحلة التعليم هذه ... لأن النظام سيتعلمها وسيتعرف عليها بإنها عملية عادية (عمل يومي أو أجراء روتيني مثلاً) وبالتالي لن يقوم بعملية حمايتها ... لن نثق بالمستخدم root بعد اليوم :)

يعني أمثلة على ذلك في مرحلة التعليم:

- لا تقوم بإنشاء حساب مستخدم

- لا تقوم بعملية mount أو umount لبارتشنات

- لا تقوم بعملية إيقاف أو تشغيل خدمة ما

- لا تقوم بعملية التعديل على الجدار الناري

- لا تقوم بعملية إدخال أو إخراج لموديول للنواة

- لا تقوم "أكرر" بأي عمل تنفيذي يستوجب تدخل مدير النظام

- المستخدم root لم يعد محل ثقة فأنتبه

**ملاحظة:** حتى عملية إستعمال الأمر w و top وغيرها من الأدوات إن لم يتعلم عليها النظام؟ فلن يسمح لك بإستعمالها !!!

الآن لدخول مرحلة التعليم نفذ الأمر التالي:

gradm -F -L /etc/grsec/learned_tasks.log

الآن أترك النظام يعمل ليوم أو يومين حسب طبيعة عملك على النظام هذا لكي يقوم نظام الـ RBAC بالتعلم ودراسة النظام بشكل صحيح وأيضاً لكي تكون عندك فرصة كبيرة لتشغيل جميع ما تحتاجهم بشكل إعتيادي قبل أن تنهي مرحلة الدراسة للنظام ...

بعد يوم أو يومين أنتهيت وتقول كل شيء تمام؟ الآن لنوقف مرحلة التعليم من خلال الأمر:

gradm -F -L /etc/grsec/learned_tasks.log -O /etc/grsec/acl

الآن هكذا الـ Policy العامة التي سيسير عليها النظام أصبحت معروفة له وتستطيع تفعيلها له من خلال الأمر:

gradm -E

الآن أصبح نظام الـ RBAC يعمل وشغال على الـ Policy التي حددتها له ...

الآن نحتاج لعمل كلمة سرية للمستخدم الذي قادر على تشغيل نظام الحماية هذا أو إيقافه من خلال تنفيذ الأمر:

gradm -P

نصيحة لله ضع كلمة سرية معقدة وطويلة عليه ...

**الآن ماذا لو أردت إيقاف نظام الـ RBAC ماذا أفعل؟**

الجواب: نفذ الأمر

gradm -D

سيطلب منك إدخال كلمة السر التي عملتها بالأعلى ...

**طيب الآن أنا محتاج لإجراء عمل administrative ماذا أفعل؟**

الجواب: قم بالدخول الى admin role الخاص بالنظام من خلال تنفيذ الأمر:

gradm -a admin

**طيب الآن أنتهيت من ما أريد القيام به، كيف أخرج من admin role؟**

الجواب: قم بالخروج من خلال تنفيذ الأمر:

gradm -u admin

طيب الآن قمت بتنفيذ مرحلة التعليم ولكن هناك برنامج binary أريد أسمح بإستعماله، ماذا أفعل؟

الجواب: أستعمل برنامج chpax الذي طوروه جماعة الـ PaX ...

**طيب سؤال، بما إنه النظام يقوم بحفظ كلمة السر الخاصة بالـ admin role في الملف**

/etc/grsec/pw

**إذن يستطيع root من قراءة محتواه ومن ثم أخذه ومحاولة فك تشفيره؟**

الجواب: عندما يتم تفعيل الـ RBAC فإنه حتى الـ admin role لا يستطيع قراءة محتوى هذا الملف، ولا حتى محتوى المجلد الذي هو فيه ... وأيضاً لو قمت بالتلاعب بالـ policy من أجل السماح بعملية قراءة هذا المجلد؟ فإن الـ RBAC System لن يعمل ولن يسمح لك بذلك ولهذا لا تقلق ...

**الموضوع إهداء خاص لأخوي العزيز صبري (KING SABRI) وأعذرني تأخرت عليك شهور :$ وإهداء لكل أعضاء وزوار [مجتمع لينوكس العربي](http://linuxac.org) ولكل الأخوة أصحاب المواقع العربية المفيدة لنا كعرب ... وإن شاء الله سترون مفاجئات أخرى بإذن الله في أقرب فرصة ممكنة ...**

مصادر مفيدة جداً:

[الأول](http://en.wikipedia.org/wiki/Role-based_access_control) | [الثاني](http://csrc.nist.gov/groups/SNS/rbac/documents/design_implementation/Intro_role_based_access.htm) | [الثالث](http://www.amazon.com/Role-Based-Access-Control-David-Ferraiolo/dp/1580533701) | [الرابع](http://pax.grsecurity.net/) | [الخامس](http://www.grsecurity.com/)

بالتوفيق للجميع ...
